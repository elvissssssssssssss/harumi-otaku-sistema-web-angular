<div class="pedidos">
  <h2>Pedidos (Admin)</h2>

  <div *ngIf="mensajeError" class="alert alert-danger">
    {{ mensajeError }}
  </div>

  <div *ngIf="mensajeExito" class="alert alert-success">
    {{ mensajeExito }}
  </div>

  <section class="card">
    <div class="card-header">
      <h3>Órdenes</h3>
      <button type="button" (click)="loadOrdenes()" [disabled]="isLoading">Recargar</button>
    </div>

    <div *ngIf="isLoading">Cargando órdenes...</div>

    <table *ngIf="!isLoading" class="table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Usuario</th>
          <th>Pickup</th>
          <th>Total</th>
          <th>Estado</th>
          <th>Creada</th>
          <th></th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let o of ordenes">
          <td>{{ o.id }}</td>
          <td>{{ o.usuarioId }}</td>
          <td>{{ o.pickupAt | date:'yyyy-MM-dd HH:mm' }}</td>
          <td>{{ o.totalAmount }}</td>
          <td>{{ o.estadoCodigo || '—' }} / {{ o.estadoNombre || '—' }}</td>
          <td>{{ o.createdAt | date:'yyyy-MM-dd HH:mm' }}</td>
          <td>
            <button type="button" (click)="verDetalle(o.id)">Ver detalle</button>
          </td>
        </tr>

        <tr *ngIf="ordenes.length === 0">
          <td colspan="7">No hay órdenes.</td>
        </tr>
      </tbody>
    </table>
  </section>

  <section class="card" *ngIf="selectedOrden as d">
    <div class="card-header">
      <h3>Detalle orden #{{ d.id }}</h3>
    </div>

    <div *ngIf="isLoadingDetalle">Cargando detalle...</div>

    <div *ngIf="!isLoadingDetalle" class="grid">
      <div>
        <p><strong>Usuario:</strong> {{ d.usuarioId }}</p>
        <p><strong>Pickup:</strong> {{ d.pickupAt | date:'yyyy-MM-dd HH:mm' }}</p>
        <p><strong>Total:</strong> {{ d.totalAmount }}</p>
        <p><strong>Estado:</strong> {{ d.estadoCodigo }} / {{ d.estadoNombre }}</p>
        <p><strong>Creada:</strong> {{ d.createdAt | date:'yyyy-MM-dd HH:mm' }}</p>
      </div>

      <div>
        <h4>Items</h4>
        <table class="table">
          <thead>
            <tr>
              <th>Producto</th>
              <th>Cant.</th>
              <th>Precio</th>
              <th>Subtotal</th>
            </tr>
          </thead>

          <tbody>
            <tr *ngFor="let it of d.items">
              <td>{{ it.nombre }}</td>
              <td>{{ it.cantidad }}</td>
              <td>{{ it.precioUnitario }}</td>
              <td>{{ it.subtotal }}</td>
            </tr>

            <tr *ngIf="d.items?.length === 0">
              <td colspan="4">Sin items.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="card-sub">
      <h4>Cambiar estado</h4>

      <form [formGroup]="formEstado" (ngSubmit)="cambiarEstado()">
        <label>Estado</label>
        <select formControlName="estadoCodigo">
          <option value="">-- Selecciona --</option>
          <option value="CREADA">CREADA</option>
          <option value="PENDIENTE">PENDIENTE</option>
          <option value="PREPARANDO">PREPARANDO</option>
          <option value="LISTO">LISTO</option>
          <option value="ENTREGADO">ENTREGADO</option>
          <option value="CANCELADA">CANCELADA</option>
        </select>

        <div *ngIf="formEstado.get('estadoCodigo')?.touched && formEstado.get('estadoCodigo')?.invalid"
             class="text-danger">
          Selecciona un estado.
        </div>

        <label>Comentario</label>
        <input type="text" formControlName="comentario" placeholder="Opcional" />

        <button type="submit">Actualizar</button>
      </form>
    </div>

    <div class="card-sub">
      <h4>Historial de estados</h4>

      <div *ngIf="isLoadingHistorial">Cargando historial...</div>

      <table *ngIf="!isLoadingHistorial" class="table">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Estado</th>
            <th>Comentario</th>
            <th>Cambiado por</th>
          </tr>
        </thead>

        <tbody>
          <tr *ngFor="let h of historial">
            <td>{{ h.fechaCambio | date:'yyyy-MM-dd HH:mm' }}</td>
            <td>{{ h.estadoCodigo }} / {{ h.estadoNombre }}</td>
            <td>{{ h.comentario }}</td>
            <td>{{ h.cambiadoPorUsuarioId }}</td>
          </tr>

          <tr *ngIf="historial.length === 0">
            <td colspan="4">Sin historial.</td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <section class="card" *ngIf="!selectedOrden">
    <p>Selecciona una orden para ver el detalle.</p>
  </section>
</div>
